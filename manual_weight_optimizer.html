<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manual Weight Optimizer - UFC Predictor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #141414;
      --border: #222;
      --accent: #84cc16;
      --muted: #aaa;
      --text: #f5f5f5;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .title {
      font-weight: bold;
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }
    .weight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .weight-control {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .weight-label {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .weight-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #fff;
    }
    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: var(--border);
      outline: none;
      margin: 0.5rem 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }
    .weight-info {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.5rem;
    }
    .button-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .btn-test {
      background: var(--accent);
      color: var(--bg);
    }
    .btn-test:hover {
      background: #9de01b;
    }
    .btn-reset {
      background: #e74c3c;
      color: #fff;
    }
    .btn-preset {
      background: #3498db;
      color: #fff;
    }
    .btn-save {
      background: #f39c12;
      color: #fff;
    }
    .results-panel {
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .accuracy-display {
      font-size: 3rem;
      font-weight: bold;
      color: var(--accent);
      text-align: center;
      margin: 1rem 0;
    }
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }
    .stat-box {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .history-table th,
    .history-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .history-table th {
      color: var(--muted);
      font-weight: 500;
    }
    .loading {
      text-align: center;
      color: var(--muted);
      padding: 2rem;
      font-size: 1.2rem;
    }
    .best-badge {
      background: #f39c12;
      color: #000;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .change-positive {
      color: #2ecc71;
    }
    .change-negative {
      color: #e74c3c;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f39c12 50%, #2ecc71 100%);
      transition: width 0.5s;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 0.5rem;
      font-weight: bold;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <main>
    <header style="text-align: center; margin-bottom: 2rem;">
      <h1>üéõÔ∏è Manual Weight Optimizer</h1>
      <p style="color: var(--muted);">Test different weight combinations and see accuracy in real-time</p>
    </header>

    <div id="loading" class="loading">
      Loading UFC fight data... (This may take 10-20 seconds)
    </div>

    <div id="app" style="display: none;">
      <!-- Current Results Panel -->
      <div class="results-panel">
        <div class="title">Current Configuration Results</div>
        <div class="accuracy-display" id="current-accuracy">---%</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-bar" style="width: 0%">0%</div>
        </div>
        <div class="comparison-grid">
          <div class="stat-box">
            <div class="stat-label">Correct</div>
            <div class="stat-value" id="correct-count">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Tested</div>
            <div class="stat-value" id="total-count">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">vs Baseline</div>
            <div class="stat-value" id="vs-baseline">--</div>
          </div>
        </div>
      </div>

      <!-- Control Buttons -->
      <div class="button-group">
        <button class="btn-test" onclick="testCurrentWeights()">üß™ Test Current Weights</button>
        <button class="btn-reset" onclick="resetToBaseline()">üîÑ Reset to Baseline</button>
        <button class="btn-preset" onclick="loadOptimized()">‚ö° Load Optimized (66.6%)</button>
        <button class="btn-save" onclick="saveConfiguration()">üíæ Save Configuration</button>
        <button class="btn-preset" onclick="exportHistory()">üìä Export History</button>
      </div>

      <!-- Weight Controls -->
      <div class="card">
        <div class="title">Weight Controls (Drag sliders to adjust)</div>
        <div class="weight-grid" id="weight-controls"></div>
      </div>

      <!-- Test History -->
      <div class="card">
        <div class="title">Test History (Best to Worst)</div>
        <table class="history-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Accuracy</th>
              <th>vs Baseline</th>
              <th>Key Changes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <tr>
              <td colspan="5" style="text-align: center; color: var(--muted);">
                No tests run yet. Click "Test Current Weights" to begin.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // Global variables
    let csvData = [];
    let fighterFeatures = {};
    let testHistory = [];
    let baselineAccuracy = 62.13;

    const BASELINE_WEIGHTS = {
      gym_rating: 4.0,
      slpm: 3.5,
      td_def: 3.0,
      str_acc: 2.5,
      sapm: 2.2,
      str_def: 2.0,
      ko_adv: 1.8,
      age_adv: 1.5,
      td_avg: 1.2,
      sub_win_adv: 1.2,
      sub_avg: 1.0,
      td_acc: 0.8,
      experience_adv: 0.3,
      win_rate: 3.0
    };

    const OPTIMIZED_WEIGHTS = {
      gym_rating: 4.0,
      slpm: 3.5,
      td_def: 3.0,
      str_acc: 2.5,
      sapm: 2.2,
      str_def: 2.0,
      ko_adv: 1.8,
      age_adv: 0.75,  // Optimized!
      td_avg: 1.2,
      sub_win_adv: 1.2,
      sub_avg: 1.0,
      td_acc: 0.8,
      experience_adv: 0.3,
      win_rate: 3.0
    };

    const WEIGHT_INFO = {
      gym_rating: { label: 'üèÜ Gym Rating', description: '#1 Factor: 26.7% win difference', range: [0, 8], step: 0.25 },
      slpm: { label: 'ü•ä Strikes/Min', description: '59.2% correlation', range: [0, 8], step: 0.25 },
      td_def: { label: 'üõ°Ô∏è TD Defense', description: '56.3% correlation', range: [0, 6], step: 0.25 },
      str_acc: { label: 'üéØ Strike Accuracy', description: '56.0% correlation', range: [0, 5], step: 0.25 },
      sapm: { label: 'ü•ã Defensive Absorption', description: '55.3% correlation', range: [0, 5], step: 0.25 },
      str_def: { label: 'üõ°Ô∏è Strike Defense', description: '54.4% correlation', range: [0, 4], step: 0.25 },
      ko_adv: { label: 'üí• KO Power', description: 'Finish rate advantage', range: [0, 4], step: 0.1 },
      age_adv: { label: 'üë¥ Age Advantage', description: '‚ö° 0.75 is optimal!', range: [0, 3], step: 0.05 },
      td_avg: { label: 'ü§º TD Average', description: 'Takedown offense', range: [0, 3], step: 0.1 },
      sub_win_adv: { label: 'üîí Sub Win Rate', description: 'Submission skill', range: [0, 3], step: 0.1 },
      sub_avg: { label: 'üé≠ Sub Average', description: 'Sub attempts', range: [0, 2], step: 0.1 },
      td_acc: { label: 'üé≤ TD Accuracy', description: 'TD precision', range: [0, 2], step: 0.1 },
      experience_adv: { label: 'üìö Experience', description: 'Total fights (0.9 is good!)', range: [0, 2], step: 0.05 },
      win_rate: { label: 'üèÖ Win Rate', description: 'Historical success (3-9 range)', range: [0, 12], step: 0.5 }
    };

    let currentWeights = { ...BASELINE_WEIGHTS };

    // GYM RATINGS
    const GYM_RATINGS = {
      'AKA (American Kickboxing Academy) San Jose': 5.349,
      'Tiger Muay Thai - Phuket, Thailand': 3.667,
      'The Fighting Nerds': 3.134,
      'Blackzilians - Boca Raton, FL': 2.686,
      'American Top Team': 2.155,
      'Syndicate MMA': -2.653,
      'Sanford MMA': -2.131
      // ... (include more as needed)
    };

    function getGymRating(gymName) {
      if (!gymName || gymName === 'N/A' || gymName === '0' || gymName === '--') {
        return 0;
      }
      return GYM_RATINGS[gymName] || 0;
    }

    function parseNumeric(value) {
      if (!value || value === '--' || value === 'N/A') return 0;
      try {
        const num = parseFloat(String(value).replace('%', ''));
        return isNaN(num) ? 0 : num;
      } catch {
        return 0;
      }
    }

    function calculateAge(dobStr) {
      try {
        if (!dobStr || dobStr === 'N/A' || dobStr === '--') return 0;
        
        let birth;
        if (/^\d{5}$/.test(String(dobStr).trim())) {
          const excelEpoch = new Date(1899, 11, 30);
          const days = parseInt(dobStr);
          birth = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
        } else if (dobStr.includes('-') || dobStr.includes('/')) {
          birth = new Date(dobStr);
        } else {
          return 0;
        }
        
        if (isNaN(birth.getTime())) return 0;
        
        const today = new Date();
        const age = (today - birth) / (365.25 * 24 * 60 * 60 * 1000);
        
        return (age > 15 && age < 60) ? age : 0;
      } catch {
        return 0;
      }
    }

    async function loadCSVData() {
      try {
        const response = await fetch('/matchup/ufc_fight_data.csv');
        const csvText = await response.text();
        
        Papa.parse(csvText, {
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          transformHeader: function(header) {
            return header.trim();
          },
          complete: function(results) {
            csvData = results.data;
            processData();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            console.log('Data loaded successfully');
          },
          error: function(error) {
            console.error('Error parsing CSV:', error);
            document.getElementById('loading').innerHTML = '<div style="color: #e74c3c;">Error loading data. Please refresh.</div>';
          }
        });
      } catch (error) {
        console.error('Error loading CSV:', error);
        document.getElementById('loading').innerHTML = '<div style="color: #e74c3c;">Error loading data. Please refresh.</div>';
      }
    }

    function processData() {
      const fighters = new Set();
      csvData.forEach(row => {
        if (row.fighter_1) fighters.add(row.fighter_1);
        if (row.fighter_2) fighters.add(row.fighter_2);
      });

      fighters.forEach(fighter => {
        const f1Fights = csvData.filter(row => row.fighter_1 === fighter);
        const f2Fights = csvData.filter(row => row.fighter_2 === fighter);
        const allFights = [...f1Fights, ...f2Fights];
        
        if (allFights.length === 0) return;
        
        allFights.sort((a, b) => {
          const dateA = new Date(a.event_date || '1900-01-01');
          const dateB = new Date(b.event_date || '1900-01-01');
          return dateB - dateA;
        });
        
        const recent = allFights[0];
        const isF1 = recent.fighter_1 === fighter;
        const prefix = isF1 ? 'fighter_1_' : 'fighter_2_';
        
        const wins = allFights.filter(f => f.winner === fighter).length;
        const total = allFights.length;
        
        const gymName = recent[prefix + 'gym'];
        const gymRating = getGymRating(gymName);
        const age = calculateAge(recent[prefix + 'dob']);
        
        const avgStat = (stat) => {
          let sum = 0;
          allFights.forEach(fight => {
            const val = fight.fighter_1 === fighter ? fight['fighter_1_' + stat] : fight['fighter_2_' + stat];
            sum += parseNumeric(val);
          });
          return sum / allFights.length;
        };
        
        const koWins = allFights.filter(f => f.winner === fighter && f.method_main === 'KO/TKO').length;
        const subWins = allFights.filter(f => f.winner === fighter && f.method_main === 'SUB').length;
        
        fighterFeatures[fighter] = {
          gym_rating: gymRating,
          win_rate: wins / total,
          slpm: avgStat('slpm'),
          str_acc: avgStat('str_acc'),
          sapm: avgStat('sapm'),
          str_def: avgStat('str_def'),
          td_avg: avgStat('td_avg'),
          td_acc: avgStat('td_acc'),
          td_def: avgStat('td_def'),
          sub_avg: avgStat('sub_avg'),
          ko_win_rate: wins > 0 ? koWins / wins : 0,
          sub_win_rate: wins > 0 ? subWins / wins : 0,
          age: age,
          total_fights: total
        };
      });
      
      console.log(`Processed ${Object.keys(fighterFeatures).length} fighters`);
      initializeUI();
    }

    function initializeUI() {
      const container = document.getElementById('weight-controls');
      container.innerHTML = '';
      
      Object.entries(WEIGHT_INFO).forEach(([key, info]) => {
        const div = document.createElement('div');
        div.className = 'weight-control';
        
        const currentVal = currentWeights[key];
        const baselineVal = BASELINE_WEIGHTS[key];
        
        div.innerHTML = `
          <div class="weight-label">
            <span>${info.label}</span>
            <span class="weight-value" id="val-${key}">${currentVal.toFixed(2)}</span>
          </div>
          <input 
            type="range" 
            id="slider-${key}" 
            min="${info.range[0]}" 
            max="${info.range[1]}" 
            step="${info.step}" 
            value="${currentVal}"
            oninput="updateWeight('${key}', this.value)"
          >
          <div class="weight-info">
            ${info.description}<br>
            Baseline: ${baselineVal.toFixed(2)} | Range: ${info.range[0]}-${info.range[1]}
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function updateWeight(key, value) {
      currentWeights[key] = parseFloat(value);
      document.getElementById(`val-${key}`).textContent = parseFloat(value).toFixed(2);
    }

    function testCurrentWeights() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Testing...';
      
      setTimeout(() => {
        const results = runBacktest(currentWeights);
        displayResults(results);
        addToHistory(results);
        btn.disabled = false;
        btn.textContent = 'üß™ Test Current Weights';
      }, 100);
    }

    function runBacktest(weights) {
      const testData = csvData
        .sort((a, b) => new Date(b.event_date) - new Date(a.event_date))
        .slice(0, 3000);
      
      let correct = 0;
      let total = 0;
      
      testData.forEach(fight => {
        const f1 = fight.fighter_1;
        const f2 = fight.fighter_2;
        const actualWinner = fight.winner;
        
        if (!actualWinner || !f1 || !f2) return;
        if (!fighterFeatures[f1] || !fighterFeatures[f2]) return;
        if (fighterFeatures[f1].total_fights < 2 || fighterFeatures[f2].total_fights < 2) return;
        
        const feat1 = fighterFeatures[f1];
        const feat2 = fighterFeatures[f2];
        
        const scoreDiff = (
          (feat1.gym_rating - feat2.gym_rating) * weights.gym_rating +
          (feat1.win_rate - feat2.win_rate) * weights.win_rate +
          (feat1.slpm - feat2.slpm) * weights.slpm +
          (feat1.str_acc - feat2.str_acc) * weights.str_acc +
          (feat1.str_def - feat2.str_def) * weights.str_def +
          (feat2.sapm - feat1.sapm) * weights.sapm +
          (feat1.td_avg - feat2.td_avg) * weights.td_avg +
          (feat1.td_def - feat2.td_def) * weights.td_def +
          (feat1.sub_avg - feat2.sub_avg) * weights.sub_avg +
          (feat1.td_acc - feat2.td_acc) * weights.td_acc +
          (feat1.ko_win_rate - feat2.ko_win_rate) * weights.ko_adv +
          (feat1.sub_win_rate - feat2.sub_win_rate) * weights.sub_win_adv +
          (feat1.age - feat2.age) * weights.age_adv +
          (feat1.total_fights - feat2.total_fights) * weights.experience_adv
        );
        
        const predicted = scoreDiff > 0 ? f1 : f2;
        if (predicted === actualWinner) correct++;
        total++;
      });
      
      const accuracy = (correct / total * 100).toFixed(2);
      
      return {
        accuracy: parseFloat(accuracy),
        correct: correct,
        total: total,
        weights: { ...weights },
        timestamp: new Date().toLocaleTimeString()
      };
    }

    function displayResults(results) {
      document.getElementById('current-accuracy').textContent = results.accuracy.toFixed(2) + '%';
      document.getElementById('correct-count').textContent = results.correct;
      document.getElementById('total-count').textContent = results.total;
      
      const diff = results.accuracy - baselineAccuracy;
      const diffEl = document.getElementById('vs-baseline');
      diffEl.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(2) + '%';
      diffEl.className = 'stat-value ' + (diff >= 0 ? 'change-positive' : 'change-negative');
      
      const progressBar = document.getElementById('progress-bar');
      const width = Math.min(100, (results.accuracy / 70) * 100);
      progressBar.style.width = width + '%';
      progressBar.textContent = results.accuracy.toFixed(2) + '%';
    }

    function addToHistory(results) {
      testHistory.push(results);
      testHistory.sort((a, b) => b.accuracy - a.accuracy);
      
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = '';
      
      const bestAccuracy = testHistory[0].accuracy;
      
      testHistory.forEach((test, index) => {
        const row = document.createElement('tr');
        
        const keyChanges = [];
        Object.entries(test.weights).forEach(([key, val]) => {
          const baseline = BASELINE_WEIGHTS[key];
          if (Math.abs(val - baseline) > 0.01) {
            keyChanges.push(`${key}: ${val.toFixed(2)}`);
          }
        });
        
        const isBest = test.accuracy === bestAccuracy;
        const diff = test.accuracy - baselineAccuracy;
        
        row.innerHTML = `
          <td>${index + 1} ${isBest ? '<span class="best-badge">BEST</span>' : ''}</td>
          <td style="font-weight: bold; color: var(--accent);">${test.accuracy.toFixed(2)}%</td>
          <td class="${diff >= 0 ? 'change-positive' : 'change-negative'}">${(diff >= 0 ? '+' : '')}${diff.toFixed(2)}%</td>
          <td style="font-size: 0.85rem;">${keyChanges.length > 0 ? keyChanges.slice(0, 3).join(', ') : 'Baseline'}</td>
          <td>
            <button onclick="loadHistoryConfig(${index})" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; background: #3498db; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Load</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function loadHistoryConfig(index) {
      const config = testHistory[index];
      currentWeights = { ...config.weights };
      
      Object.entries(currentWeights).forEach(([key, value]) => {
        const slider = document.getElementById(`slider-${key}`);
        const display = document.getElementById(`val-${key}`);
        if (slider) slider.value = value;
        if (display) display.textContent = value.toFixed(2);
      });
      
      alert(`Loaded configuration #${index + 1} (${config.accuracy.toFixed(2)}% accuracy)`);
    }

    function resetToBaseline() {
      currentWeights = { ...BASELINE_WEIGHTS };
      initializeUI();
      alert('Reset to baseline weights');
    }

    function loadOptimized() {
      currentWeights = { ...OPTIMIZED_WEIGHTS };
      initializeUI();
      alert('Loaded optimized weights (66.60% expected accuracy)');
    }

    function saveConfiguration() {
      const config = {
        weights: currentWeights,
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ufc_weights_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportHistory() {
      if (testHistory.length === 0) {
        alert('No test history to export. Run some tests first!');
        return;
      }
      
      let csv = 'Rank,Accuracy,vs Baseline,Timestamp,';
      csv += Object.keys(BASELINE_WEIGHTS).join(',') + '\n';
      
      testHistory.forEach((test, index) => {
        const diff = test.accuracy - baselineAccuracy;
        csv += `${index + 1},${test.accuracy.toFixed(2)},${diff.toFixed(2)},${test.timestamp},`;
        csv += Object.values(test.weights).map(v => v.toFixed(2)).join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `weight_test_history_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initialize
    loadCSVData();
  </script>
</body>
</html>